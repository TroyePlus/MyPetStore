<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link type="text/css" href="../layui/css/layui.css" rel="stylesheet">
    <link href="../assets/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="../css/style.css"/>
    <link href="../assets/css/codemirror.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/ace.min.css"/>
    <link rel="stylesheet" href="../Widget/zTree/css/zTreeStyle/zTreeStyle.css" type="text/css">
    <link rel="stylesheet" href="../assets/css/font-awesome.min.css"/>

    <!--[if IE 7]>
    <link rel="stylesheet" href="../assets/css/font-awesome-ie7.min.css"/>
    <![endif]-->
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="../assets/css/ace-ie.min.css"/>
    <![endif]-->
    <script src="../assets/js/jquery.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="../layui/layui.js"></script>
    <!-- <![endif]-->
    <!--[if IE]>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <![endif]-->
    <!--[if !IE]> -->
<!--    <script type="text/javascript">-->
<!--        window.jQuery || document.write("<script src='../assets/js/jquery-2.0.3.min.js' type='text/javascript'>" + "<" + "/script>");-->
<!--    </script>-->
    <!-- <![endif]-->
    <!--[if IE]>
   <script type="text/javascript">-->
<!--        window.jQuery || document.write("<script src='../assets/js/jquery-1.10.2.min.js'>" + "<" + "/script>");-->
<!--    </script>-->
    <![endif]-->
    <script type="text/javascript" src="../Widget/icheck/jquery.icheck.min.js"></script>
    <script type="text/javascript" src="../Widget/Validform/5.3.2/Validform.min.js"></script>
    <script type="text/javascript" src="../js/H-ui.js"></script>
    <script type="text/javascript" src="../js/H-ui.admin.js"></script>
    <script src="../assets/js/ace-elements.min.js" type="text/javascript"></script>
    <script src="../assets/js/ace.min.js" type="text/javascript"></script>
    <script src="../assets/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../assets/js/typeahead-bs2.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="../Widget/zTree/js/jquery.ztree.all-3.5.min.js"></script>
    <script src="../js/lrtk.js" type="text/javascript"></script>
    <title>分类管理</title>
</head>

<body>
<div class=" clearfix">
    <div id="category">

        <div id="scrollsidebar" class="left_Treeview">
            <div class="show_btn" id="rightArrow"><span></span></div>
            <div class="widget-box side_content">
                <div class="side_title"><a title="隐藏" class="close_btn"><span></span></a></div>
                <div class="side_list">
                    <div class="widget-header header-color-green2">
                        <h4 class="lighter smaller">产品类型列表</h4>
                    </div>
                    <div class="widget-body">
                        <div class="widget-main padding-8">
                            <div id="cate" class="demo-tree-more"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="type_style page_right_style layui-col-md6 layui-col-md-offset3">
            <div class="type_title">产品类型信息</div>
            <div class="type_content">
                <div class="Operate_btn">
                    <a href="#" class="btn  btn-success" id="btn_add"><i
                            class="icon-edit align-top bigger-125"></i>新增子类型</a>
<!--                    <a href="javascript:ovid()" class="btn  btn-warning"><i-->
<!--                            class="icon-ok align-top bigger-125"></i>禁用该类型</a>-->
                    <a href="#" class="btn  btn-danger" id="btn_del"><i
                            class="icon-trash   align-top bigger-125"></i>删除该类型</a>
                </div>
                <form action="#" class="form form-horizontal" id="form">
                    <div class="Operate_cont clearfix">
                        <label class="form-label"><span class="c-red">*</span>分类ID：</label>
                        <div class="formControls ">
                            <input type="text"  class="input-text" value="" placeholder="" id="catId"
                                   name="categoryId">
                        </div>
                    </div>
                    <div class="Operate_cont clearfix">
                        <label class="form-label"><span class="c-red"></span>名称：</label>
                        <div class="formControls ">
                            <input type="text" id="name" class="input-text" value="" placeholder=""
                                   name="name">
                        </div>
                    </div>
                    <div class="Operate_cont clearfix">
                        <label class="form-label">备注：</label>
                        <div class="formControls">
                                <textarea name="text" id="text" rows="" class="textarea" placeholder="说点什么..."
                                          dragonfly="true"
                                          onKeyUp="textarealength(this,100)"></textarea>
                            <p class="textarea-numberbar"><em class="textarea-length">0</em>/100</p>
                        </div>
                    </div>
                    <div class="">
                        <div class="" style=" text-align:center">
                            <input class="btn btn-primary radius" id="btn_submit" type="button" value="保存">
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</body>
</html>
<script type="text/javascript">
    $(function() {
        $("#category").fix({
            float : 'left',
            //minStatue : true,
            skin : 'green',
            durationTime :false
        });
    });
    //初始化宽度、高度
    $(".widget-box").height($(window).height());
    $(".page_right_style").width($(window).width()-400);
    //当文档窗口发生改变时 触发
    $(window).resize(function(){
        $(".widget-box").height($(window).height());
        $(".page_right_style").width($(window).width()-400);
    });

    $(function(){
        $('.skin-minimal input').iCheck({
            checkboxClass: 'icheckbox-blue',
            radioClass: 'iradio-blue',
            increaseArea: '20%'
        });

        // $("#form").Validform({
        //     tiptype:2,
        //     callback:function(form){
        //         form[0].submit();
        //         var index = parent.layer.getFrameIndex(window.name);
        //         parent.$('.btn-refresh').click();
        //         parent.layer.close(index);
        //     }
        // });
    });
    var flag = 0;
    var data = "";
    // ！先请求加载数据，再渲染树形结构
    $(function(){
        var url = '/backstage/categories/idTree';
        $.get(url,function (result) {
            //"json" - 以 JSON 运行响应，并以 JavaScript 对象返回,故还需转化
            data = result;
        },"json");
    });

    var initId = "";

    layui.use('tree', function(){
        var tree = layui.tree;
        console.log(data);

        //渲染
        var inst1 = tree.render({
            elem: '#cate'  //绑定元素
            , id: 'catTree'
            , data: data
            , showLine:false     //是否开启连接线
            , click: function (obj) {   //节点被点击的回调
                fillForm(obj.data);
                initId = obj.data.id;
            }
        });
    });
    
    function fillForm(data) {
        var url = '/backstage/categories';
        var reqData = {"id":data.id};
        $.get(url,reqData,function (result) {
            if(result.status==1){
                $('#catId').val(result.data.categoryId);
                $('#name').val(result.data.name);
                $('#text').val(result.data.text);
                $('#btn_submit').val("保存");
                flag = 0;
            }
        },"json");
    }

    $('#btn_submit').on('click', function () {
        var data = {
            "categoryId": $('#catId').val(),
            "name": $('#name').val(),
            "text": $('#text').val()
        };

        if (flag == 0) {
            data["initId"] = initId;
            $.ajax({
                type: "put",
                async: true,
                url: "/backstage/categories",
                data: data,
                dataType: "json",
                success: function (result) {
                    if(result.status==1){
                        layer.msg('保存成功!',{icon:6,time:1000});
                        //更新Tree DOM 并清空输入
                    }
                    else {
                        layer.msg('保存失败，请稍后再试!',{icon:5,time:1500});
                    }
                },
                error: function(errorMsg){
                    console.log(errorMsg);
                    layer.msg('请求失败，请稍后再试!',{icon:5,time:1500});
                }
            });
        }
        else{
            $.ajax({
                type: "post",
                async: true,
                url: "/backstage/categories",
                data: data,
                dataType: "json",
                success: function (result) {
                    if(result.status==1){
                        layer.msg('添加成功!',{icon:6,time:1000});
                        //更新Tree DOM 并清空输入
                        window.location.reload();   //刷新
                    }
                    else {
                        layer.msg('添加失败，请稍后再试!',{icon:5,time:1500});
                    }
                },
                error: function(errorMsg){
                    console.log(errorMsg);
                    layer.msg('请求失败，请稍后再试!',{icon:5,time:1500});
                }
            });
        }
    });

    $('#btn_del').on('click',function () {
        $.ajax({
            type: "delete",
            async: true,
            url: "/backstage/categories",
            data: {"catId": initId},
            dataType: "json",
            success: function (result) {
                if(result.status==1){
                    layer.msg('删除成功!',{icon:6,time:1000});
                    //更新Tree DOM 并清空输入
                    window.location.reload();
                }
                else {
                    layer.msg('删除失败，请稍后再试!',{icon:5,time:1500});
                }
            },
            error: function(errorMsg){
                console.log(errorMsg);
                layer.msg('请求失败，请稍后再试!',{icon:5,time:1500});
            }
        });
    });

    $('#btn_add').on('click',function () {
        clearInfo();
    });
    
    function clearInfo() {
        $('#catId').val("");
        $('#name').val("");
        $('#text').val("");
        $('#btn_submit').val("添加");
        flag = 1;
    }

    // var reData='';
    function tree_reload(){
        // $.ajax({
        //     type: "get",
        //     async: true,
        //     url: "/backstage/categories/idTree",
        //     dataType: "json",
        //     success: function (result) {
        //         reData = result;
        //     }
        // });


        layui.use('tree', function(){
            var tree = layui.tree;

            console.log(reData);

            //渲染
            tree.reload('catTree',{data: data});
        });
    }

</script>